### 1. 简介

前两章讲了定位的概率方法，是一个低维度感知问题，假设地图已知。  
但有些情况地图未知，或者不准确。  
因此建图可以让部署机器人更容易，也会让机器人更能适应环境变化。  
建图是真正的自动机器人的核心竞争力之一。  

建图难在：  
1. **假设空间巨大**:   
    地图定义在连续空间上，因此无限高维度；即使离散化，维度也很高。  
    因此贝叶斯滤波的方法不好使。  
2. **建图是一个“鸡-蛋”问题**:   
    有地图定位很容易，有定位建图也不难；
    但机器人的里程计精度会逐渐降低，因此建图的时候需要同时定位。  

影响建图的难度的因素有:   
尺寸，感知和执行的噪声，感知模糊度（不同地方的相似度），闭环场景。  

本章首先假设定位已知，然后介绍一系列算法，统称为*occupancy grids*。  
占据栅格地图课从有噪、不确定的测量数据中构建连续的地图。  
其思想是用一个在均匀分布的栅格中的随机变量场来表示地图。  
每一个随机变量都是二值的，对应其位置是否被占据。
占据栅格地图算法实现了这些随机变量的后验概率估计。  

这种地图的用处在于后加工（post-processing）。  
因为SLAM产生的地图不适于路径规划与导航，  
因此经常在SLAM之后使用占据栅格地图地图算法。  

### 2. 占据栅格建图算法

目标是计算地图后验$p(m|z_{1:t},x_{1:t})$。  
由于假设位姿信息已知，因此无需控制信息$u$。  

算法使用的是高分辨率的栅格，最常用的领域是二维建筑平面图。  
算法也可以泛化至三维，但计算量很大。  

把第$i$个格子记为$\bm{m}_i$；  
栅格地图由有限多个格子构成，即$m=\sum_i\bm{m}_i$。  
每个$\bm{m}_i$都可以取两个值，1为占据，0为自由。  
表达式$p(\bm{m}_i=1)$和$p(\bm{m}_i)$均指格子被占据的概率。  

地图后验的问题在于其维度。  
解决的标准做法是估计所有小格子的概率，即$p(\bm{m}_i|z_{1:t},x_{1:t}$。  
这样就不能表征相邻格子之间的相关性，即假设格子间独立：  
$p(m|z_{1:t},x_{1:t})=\Pi_i p(\bm{m}_i|z_{1:t},x_{1:t}$  

可以使用二项贝叶斯滤波器来估计每个格子的值，参考章节4.1.4。  
滤波器中使用log-odds表示，即
$l_{t,i}=\log\frac{p(\bm{m}_i|z_{1:t},x_{1:t})}{1-p(\bm{m}_i|z_{1:t},x_{1:t})}$  
这种表达的优点是可以回避逼近0值或1值时的数值不稳定问题。  
由log-odds ratio计算概率表达式：
$p(\bm{m}_i|z_{1:t},x_{1:t})=1-\frac{1}{1+\exp \{l_{t,i}\}}$  

**算法 occupancy_grid_mapping($\{l_{t-1,i}\},x_t,z_t$):**  
1····for all cells $\bm{m}_i$ do
2········if $\bm{m}_i$ in perceptual field of $z_t$ then
3············$l_{t,i}=l_{t-1,i}+\bm{inverse_sensor_model}(\bm{m}_i,x_t,z_t)-l_0$  
4········else
5············$l_{t,i}=l_{t-1,i}$  
6········endif
7····endfor
8····return $\{l_{t,i}\}  

算法中使用inverse_sensor_model(即$p(\bm{m}_i|z_t,x_t)$)来更新。  
对于锥状测距传感器的逆测量模型为：  
1. 如果不在测量范围内，则为$l_0$。
2. 如果在，且$z_t^k < z_{max}$，且$|r-z_t^k|<\alpha/2$，则为$l_{occ}$  
3. 如果在，且$r\leq z_t^k$，则为$l_{free}$。  
$l_0$是log概率比值比的先验，即$l_0=\log\frac{p(\bm{m}_i=1)}{p(\bm{m}_i=0)}$  

前面的算法都只使用传感器数据来更新地图，但还可以使用机器人占据的空间信息；  
这个信息可以加进inverse传感器模型中。

#### 2.1 多传感器融合

不同传感器建图的方法不同：  
如对于双目，可以把得到的视差图投影到二维空间上，然后对结果用高斯核卷积。  

有两种方法可以处理多种传感器的数据：  
1. 使用不同的传感器模型来对一张地图进行更新。但是不同传感器检测到不同障碍物，贝叶斯滤波的结果不make sense。
2. 不同传感器分别构建地图，然后总的地图取最保守的估计（最大值），即
$\bm{m}_i=\max_k \bm{m}_i^k$。

### 3. 学习逆测量模型

#### 3.1 对测量模型求逆

称$p(\bm{m}_i|x,z)$为逆的原因是：
它根据由这个世界造成的测量数据，提供关于这个世界的信息。

下面推导逆测量模型。  
根据贝叶斯定律：  
$p(\bm{m}_i|x,z)=\eta \int_{m:m(i)=\bm{m}_i}p(z|x,m)p(m_dm$$  
即对第$i$个格子取值为$\bm{m}_i$的所有地图积分。  
很明显，地图太多，无法积分，需要近似。  
近似算法包括使用测量模型生成样本，然后使用函数近似器来近似这个逆。

#### 3.2 由正向测量模型生成样本


