### 4. 距离传感器的似然场（Likelihood Fields）

#### 4.1 基础算法

光束模型的优点是与测距传感器的几何和物理紧密相关，但是有两个缺点：

1. **不平滑**：在有很多小障碍物的零乱空间中，$p(z_t^k|x_t,m)$对$x_t$可能很不平滑，导致近似的置信度会与真实的不同，也就是对近似的精确度要求更高。且梯度上升（hill climbing）找最大似然状态的方法会陷入局部极值。
2. **计算复杂**：ray casting要么要在线算，要么占内存（上一章节）。

另一种模型为**似然场模型（likelihood field model）**，跟物理模型无关，但在零乱空间中更平滑，且计算更快。  

首先，已知机器人状态$x_t=(\begin{matrix}x & y & \theta\end{matrix})^T$与第$k$个传感器与机器人的相对位姿$x_t=(\begin{matrix}x_{k,sens} & y_{k,sens} & \theta_{k,sens}\end{matrix})^T$，将传感器测量的测量点转换到世界坐标系下，得到($\begin{matrix}x_{z_t^k} & y_{z_t^k}\end{matrix})^T$。只有当传感器检测到障碍物（即测量值不是最大值）时，这些转换的坐标才有意义，最大值数据被扔掉。

与光束模型类似，假设三种噪声源：

1. **测量噪声（与光束模型不同）**：对地图上所有点，计算测量出障碍物的可能性$p_{hit}$。这可能性取决于这个点到离他最近的障碍物的距离（类似距离场），然后测量概率是零均值高斯，即$p_{hit}(z_t^k|x_t,m)=\epsilon_{\sigma_{hit}^2}(dist^2)$。得到整个地图所有cell的$p_{hit}$后，取与光束相交的部分，再归一化。
2. **Failures**：返回最大值，有一个类似冲击函数的分布$p_{max}$
3. **随机测量**：在$[0:z_{max}]$上的均匀分布$p_{rand}$

测量模型概率即三者以权重$p_{hit}$，$p_{rand}$，$p_{max}$线性叠加。

调整内参的方法与光束模型相同，可手调，也可以用最大似然估计器。

**算法**：  
1····$q=1$
2····for all $k$ do
3········if $z_t^k \neq z_{max}$
4············compute end point in world frame ($x_{z_t^k}$, $y_{z_t^k}$) and dist^2
5············**$q=q \dot (z_{hit} \dot prob(dist^2, \sigma_{hit}^2)+\frac{z_{random}}{z_{max}})$**
6····return $q$

计算量最大的一步是找最近的障碍物，得到$dist^2$（不过有距离场计算的包？SDF？）。可以将环境离散化（2D），然后提前计算好，到时候查表。

#### 4.2 扩展

由于欧氏距离平滑，所以似然场得到的结果也比较平滑。

**缺点**：  

1. 模型中没有显式加入动态障碍物（如人）。
2. 认为传感器可以看穿墙，因为不用ray casting了。
3. 不考虑地图的不确定性，不可用于未经探索的区域。不过可以将未知区域的测量概率设为常量$\frac{1}{z_{max}}$，即在未知区域内各种测量的概率相等（问：难道不应该是有障碍物的概率相等，所以测量概率越近越大？答：似然场的方法中，测量概率只与这个点到最近障碍物的距离有关，即仅与这个点的局部几何特征相关，而与光束追踪的历史无关，所以有障碍物等概率与测量等概率是等价的）。

现在的似然场用的是扩展的对称算法。


### 5 基于相关性的（Correlation-Based）传感器模型

有很多测距传感器模型，测量的是一次measurement和地图之间的相关性。  
一个常用的技巧叫*map matching*，可以将scan转换成occupancy grid。  
通常是将少数几个连续的scan叠加为一个局部地图，记为$m_{local}$。  
传感器测定模型将$m_{local}$与全局地图$m$作对比，也就是两者越像则$p(m_{local}|x_t,m)$越大。局部地图的cells首先要变换到全局地图坐标系中。  
**地图相关性函数**：  
$\rho_{m,m_{local},x_t}=\frac{\Sigma_{x,y}(m_{x,y}-\bar{m})\cdot(m_{x,y,local(x_t)}-\bar{m})}{\sqrt{\Sigma_{x,y}(m_{x,y}-\bar{m})^2\Sigma_{x,y}(m_{x,y,local(x_t)}-\bar{m})^2}}$

上式中，$\bar{m}$是全局和局部地图的重叠区域的总均值，得到的相关性取值分为是$[-1,1]$。然后，map matching认为$p(m_{local}|x_t,m)=max\{\rho_{m,m_{local},x_t},0\}$。

地图匹配法的优点：容易计算（但是结果不平滑）。一种得到似然场的方式就是先给地图做高斯模糊（用高斯核卷积），然后在结果中做地图匹配。相比似然场方法，地图匹配的一大优势就是显式考虑了两个地图中的自由空间，而前者只考虑了对应障碍物的传感器测量点。

地图匹配的缺点：很多建图方法构建的地图超出了传感器测量范围，从而影响地图匹配。地图匹配方法也没有一个物理解释。相关性定义为地图距离平方的归一化，与传感器的噪声模型没有关系。

### 6 基于特征的传感器模型

#### 6.1 特征提取

前文所讲的传感器模型都是基于传感器的原始数据（raw data）。  
定义特征提取函数$f$，则得到的特征是$f(z_t)$。  
通常从高维传感器测量数据中提取少量的特征。  
一大优势是降低计算复杂度。  
对于测距传感器，通常提取线、角、局部极小值，对应墙壁、角落、物体。  

#### 6.2 地标测量（Landmark Measurements）

机器人应用中，特征对应物理世界中不同物体，室内室外不同。将这些物理物体称之为地标，表明他们被用于导航。

每一个地标对应的数据包括相对机器人的距离（$r$）和方向($\phi$)，也包括一个签名（$s$，如种类、颜色、高度等）。

通常假设不同特征条件独立，即$p(f(z_t)|x_t,m)=\Pi_ip(r_t^i,\phi_t^i,s_t^i|x_t,m)$，当不同特征测量的噪声相互独立时成立，此时可以对不同特征进行依次（独立）处理。

基于特征的传感器模型：对距离、方向、签名各有独立的高斯噪声，对于特征地图中第$j$个地标，生成$t$时刻测量的第$i$个特征，模型简单的由几何关系得到，不写了。

#### 6.3 已知配对(Correspondence)时的传感器模型

对一个特征$f_t^i$，用变量$c_t^i$存储它的身份，可以取值为$1$到$N+1$，$N$是地图中地标总数，即如果$c_t^i=j$，则$f_t^i$就对应地图中第$j$个特征。当没有匹配时，$c_t^i=N+1$。

计算得到一个有匹配$c_t^i$的特征$f_t^i$的算法是首先计算应有的距离$\hat{r}$、方向$\hat{\phi}$和签名$s_j$，然后根据距离和高斯噪声模型得到概率，即$q=prob(r_t^i-$\hat{r}$, \sigma_r^2)\cdot prob(\phi_t^i-$\hat{\phi}$, \sigma_{\phi}^2)\cdot prob(r_s^i-$\hat{s}$, \sigma_s^2)$

#### 6.4 采样位姿

有时需要对对应某特征$f_t^i$的机器人位姿$x_t$进行采样。在地标模型下，这个采样可以比较高效，但需要额外的假设：需要知道先验概率$p(x_t|c_t^i,m)$。由于距离和方向提供了两个自由度的信息，而机器人状态是三维的，所以需要在第三个维度上采样，同时叠加一个高斯。采样的结果通常是围绕地图上地标的环形分布。

#### 6.5 其他考虑

上述的两种算法都是基于配对已知。  
关于特征的签名，大多数算法没有使用，也就是不对地标进行区分。但签名容易提取，且可以提供有价值的信息。  

从测量数据中提取特征是有代价的，虽然在研究中通常认为$p(f(z_t)|x_t,m)\approx p(z_t|x_t,m)$，但实际中牺牲了很多信息。  
*现在计算机发达，特征方法已经不太重要了。*大多数state-of-the-art的方法都使用稠密的测量数据。

### 7. 实际考虑

在选择传感器模型时，通常要权衡物理真实度和其他属性，例如平滑性（没有平滑性对后续算法不好，如粒子滤波器）。  
总的来说模型越准越好，从传感器中能提取的信息越多越好。  
在调模型内参的时候，可以把不确定性放大一些，因为其实没有对所有的噪声源进行建模，导致模型可能会过度自信。所以可以减少从测量中提取的信息，如在3.4节中讲的。